<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Run Stuti Run!</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700&display=swap');

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #ffe6e9;
            font-family: 'Nunito', sans-serif;
            touch-action: none;
            user-select: none;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100vh;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .hud {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .score-box {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 20px;
            padding: 10px 20px;
            box-shadow: 0 4px 15px rgba(255, 105, 180, 0.2);
            font-family: 'Fredoka One', cursive;
            color: #ff6b81;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
            pointer-events: auto;
        }

        .heart-icon {
            color: #ff4757;
        }

        #start-screen, #game-over-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            pointer-events: auto;
            max-width: 80%;
            border: 4px solid #ffccd5;
            z-index: 10;
        }

        h1 {
            font-family: 'Fredoka One', cursive;
            color: #ff6b81;
            margin: 0 0 10px 0;
            font-size: 2rem;
        }

        p {
            color: #7f8c8d;
            margin: 10px 0 20px 0;
            font-size: 1.1rem;
        }

        button {
            background: linear-gradient(to bottom, #ff9ff3, #f368e0);
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            color: white;
            font-family: 'Fredoka One', cursive;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 5px 0 #d956c8;
            transition: transform 0.1s;
        }

        button:active {
            transform: translateY(5px);
            box-shadow: 0 0 0 #d956c8;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="hud">
            <div class="score-box">
                <span class="heart-icon">â™¥</span> <span id="scoreDisplay">0</span>
            </div>
            <div class="score-box" style="font-size: 1rem; opacity: 0.8;">
                Best: <span id="highScoreDisplay">0</span>
            </div>
        </div>
    </div>

    <div id="start-screen">
        <h1>Run Stuti Run!</h1>
        <p>Tap, Click, or Spacebar to jump.<br>The Boy will cheer you on!</p>
        <button onclick="startGame()">Start Running</button>
    </div>

    <div id="game-over-screen" class="hidden">
        <h1>Oh no!</h1>
        <p>You tripped! <br>Score: <span id="finalScore">0</span></p>
        <button onclick="resetGame()">Try Again</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        // --- ASSETS ---
        const SVG_GIRL = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
            <g id="body">
                <path d="M20,30 Q10,50 15,80 L85,80 Q90,50 80,30 Z" fill="#2c3e50"/>
                <rect x="35" y="60" width="30" height="25" rx="5" fill="#a8e6cf"/>
                <circle cx="50" cy="70" r="5" fill="white" opacity="0.8"/>
                <path d="M35,85 L35,95 M65,85 L65,95" stroke="#333" stroke-width="4" stroke-linecap="round"/>
                <circle cx="50" cy="40" r="22" fill="#ffeaa7"/>
                <path d="M28,25 Q50,45 72,25 Q50,10 28,25" fill="#2c3e50"/>
                <path d="M28,25 Q15,40 20,60" fill="none" stroke="#2c3e50" stroke-width="2"/>
                <path d="M72,25 Q85,40 80,60" fill="none" stroke="#2c3e50" stroke-width="2"/>
                <g fill="none" stroke="#333" stroke-width="2">
                    <circle cx="42" cy="42" r="6"/>
                    <circle cx="58" cy="42" r="6"/>
                    <line x1="48" y1="42" x2="52" y2="42"/>
                </g>
                <circle cx="42" cy="42" r="2" fill="#4a3b32"/>
                <circle cx="58" cy="42" r="2" fill="#4a3b32"/>
                <path d="M47,52 Q50,55 53,52" fill="none" stroke="#4a3b32" stroke-width="1.5"/>
            </g>
        </svg>`;

        const SVG_BOY = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
             <path d="M10,80 Q25,60 40,80 T70,80 T90,80" fill="#f0f2f5" stroke="#dfe4ea" stroke-width="2"/>
             <g transform="translate(0, -10)">
                <path d="M30,90 L70,90 L65,60 L35,60 Z" fill="#74b9ff"/>
                <path d="M48,70 L52,70 L50,80 Z" fill="white"/>
                <path d="M30,90 Q10,95 35,95" fill="none" stroke="#333" stroke-width="5" stroke-linecap="round"/>
                <path d="M70,90 Q90,95 65,95" fill="none" stroke="#333" stroke-width="5" stroke-linecap="round"/>
                <circle cx="50" cy="40" r="20" fill="#ffeaa7"/>
                <path d="M35,45 Q50,65 65,45 L65,40 L35,40 Z" fill="#5d4037" opacity="0.9"/>
                <path d="M25,35 Q50,10 75,35 Q80,25 70,15 Q50,5 30,15 Q20,25 25,35" fill="#5d4037"/>
                <circle cx="43" cy="40" r="5" fill="none" stroke="silver" stroke-width="1.5"/>
                <circle cx="57" cy="40" r="5" fill="none" stroke="silver" stroke-width="1.5"/>
                <line x1="48" y1="40" x2="52" y2="40" stroke="silver" stroke-width="1.5"/>
                <circle cx="43" cy="40" r="2" fill="#333"/>
                <path d="M54,40 L60,40" stroke="#333" stroke-width="2"/> 
                <circle cx="20" cy="60" r="5" fill="#ffeaa7"/>
                <rect x="18" y="60" width="4" height="10" fill="#ffeaa7" transform="rotate(-15 20 60)"/>
            </g>
        </svg>`;

        const SVG_HEART = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
            <path d="M50,80 Q20,55 20,35 Q20,15 40,15 Q50,15 50,30 Q50,15 60,15 Q80,15 80,35 Q80,55 50,80 Z" fill="#ff4757" stroke="#ff6b81" stroke-width="2"/>
        </svg>`;

        // --- GAME ENGINE ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        const girlImg = new Image(); girlImg.src = "data:image/svg+xml;base64," + btoa(SVG_GIRL);
        const boyImg = new Image(); boyImg.src = "data:image/svg+xml;base64," + btoa(SVG_BOY);
        const heartImg = new Image(); heartImg.src = "data:image/svg+xml;base64," + btoa(SVG_HEART);

        let gameActive = false;
        let score = 0;
        let highScore = localStorage.getItem('stutiRunnerHighScore') || 0;
        let frames = 0;
        let gameSpeed = 5;
        let bgOffset = 0;

        let player = {
            x: 50,
            y: 0,
            width: 60,
            height: 60,
            dy: 0,
            jumpForce: 13,
            grounded: false,
            originalY: 0
        };

        const gravity = 0.6;
        const groundHeight = 100;

        let obstacles = [];
        let particles = [];
        let floaters = [];
        
        const boyPhrases = ["Come on Stuti!", "You got this!", "Go Go Go!", "Doing Great!", "Keep Running!", "Yay!", "Superb!", "Awesome!"];
        let activeSpeech = null;

        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;

        function initAudio() {
            if (!audioCtx) audioCtx = new AudioContext();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playSound(type) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            if (type === 'jump') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(400, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.1);
            } else if (type === 'collect') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(800, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.15);
            } else if (type === 'cheer') {
                osc.type = 'sine';
                [440, 554, 659].forEach((freq, i) => {
                    const o = audioCtx.createOscillator();
                    const g = audioCtx.createGain();
                    o.connect(g);
                    g.connect(audioCtx.destination);
                    o.frequency.value = freq;
                    g.gain.setValueAtTime(0.05, audioCtx.currentTime + i*0.1);
                    g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + i*0.1 + 0.3);
                    o.start(audioCtx.currentTime + i*0.1);
                    o.stop(audioCtx.currentTime + i*0.1 + 0.3);
                });
            } else if (type === 'hit') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(200, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.3);
            }
        }

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            player.originalY = canvas.height - groundHeight - player.height;
            if(player.grounded) player.y = player.originalY;
        }
        window.addEventListener('resize', resize);
        resize();

        function jump() {
            if (!gameActive) return;
            if (player.grounded) {
                player.dy = -player.jumpForce;
                player.grounded = false;
                playSound('jump');
                createParticles(player.x + player.width/2, player.y + player.height, '#fff');
            }
        }
        
        window.addEventListener('mousedown', () => { initAudio(); jump(); });
        window.addEventListener('touchstart', (e) => { e.preventDefault(); initAudio(); jump(); }, {passive: false});
        window.addEventListener('keydown', (e) => {
            if(e.code === 'Space' || e.code === 'ArrowUp') {
                initAudio();
                jump();
            }
        });

        function startGame() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-over-screen').classList.add('hidden');
            document.getElementById('highScoreDisplay').innerText = highScore;
            resetVars();
            gameActive = true;
            loop();
        }

        function resetGame() {
            startGame();
        }

        function resetVars() {
            score = 0;
            document.getElementById('scoreDisplay').innerText = score;
            gameSpeed = 6;
            obstacles = [];
            floaters = [];
            particles = [];
            activeSpeech = null;
            player.y = player.originalY;
            player.dy = 0;
            player.grounded = true;
            frames = 0;
        }

        function spawnObstacle() {
            const type = Math.random() > 0.3 ? 'heart' : 'rock';
            if (type === 'heart') {
                let hY = player.originalY - 50 - Math.random() * 100;
                obstacles.push({
                    type: 'heart',
                    x: canvas.width,
                    y: hY,
                    w: 40,
                    h: 40,
                    collected: false
                });
            } else {
                obstacles.push({
                    type: 'rock',
                    x: canvas.width,
                    y: player.originalY + 20,
                    w: 40,
                    h: 40
                });
            }
        }

        function spawnFloater() {
            floaters.push({
                x: canvas.width,
                y: player.originalY - 120,
                w: 120,
                h: 20,
                hasBoy: true,
                triggered: false
            });
        }

        function createParticles(x, y, color) {
            for(let i=0; i<5; i++) {
                particles.push({
                    x: x, 
                    y: y,
                    vx: (Math.random() - 0.5) * 5,
                    vy: (Math.random() - 0.5) * 5,
                    life: 1,
                    color: color
                });
            }
        }

        function loop() {
            if (!gameActive) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            frames++;

            bgOffset -= gameSpeed * 0.2;
            drawBackground();

            ctx.fillStyle = '#ffafbd';
            ctx.fillRect(0, canvas.height - groundHeight, canvas.width, groundHeight);
            ctx.fillStyle = '#ffc3a0';
            ctx.fillRect(0, canvas.height - groundHeight, canvas.width, 20);

            player.dy += gravity;
            player.y += player.dy;

            if (player.y > player.originalY) {
                player.y = player.originalY;
                player.dy = 0;
                player.grounded = true;
            } else {
                player.grounded = false;
            }

            // --- PLATFORM COLLISION (Physics) ---
            floaters.forEach(f => {
                // Physics collision (Landing on top)
                if (player.dy > 0 && 
                    player.y + player.height > f.y && 
                    player.y + player.height < f.y + f.h + 20 &&
                    player.x + player.width > f.x && 
                    player.x < f.x + f.w) {
                    
                    player.y = f.y - player.height;
                    player.dy = 0;
                    player.grounded = true;
                }

                // --- NEW MOTIVATION TRIGGER (Proximity) ---
                // Trigger whenever the boy is on screen and close to the player
                // We no longer require landing on him.
                if(f.hasBoy && !f.triggered) {
                    // If boy is within 300px of player on X axis
                    if (Math.abs(player.x - f.x) < 300) {
                        f.triggered = true;
                        triggerBoySpeech(f.x, f.y);
                        playSound('cheer');
                    }
                }
            });

            let bob = Math.sin(frames * 0.2) * 3;
            ctx.save();
            ctx.translate(player.x, player.y + (player.grounded ? bob : 0));
            if(player.grounded) ctx.rotate(0.1); 
            ctx.drawImage(girlImg, 0, 0, player.width, player.height);
            ctx.restore();

            for (let i = obstacles.length - 1; i >= 0; i--) {
                let obs = obstacles[i];
                obs.x -= gameSpeed;

                if (obs.type === 'heart') {
                    if (!obs.collected) {
                        let floatY = Math.sin(frames * 0.1) * 5;
                        ctx.drawImage(heartImg, obs.x, obs.y + floatY, obs.w, obs.h);
                    }
                } else if (obs.type === 'rock') {
                    ctx.fillStyle = '#95a5a6';
                    ctx.beginPath();
                    ctx.arc(obs.x + obs.w/2, obs.y + obs.h/2, obs.w/2, 0, Math.PI*2);
                    ctx.fill();
                    ctx.fillStyle = '#7f8c8d';
                    ctx.beginPath();
                    ctx.arc(obs.x + obs.w/2 - 5, obs.y + obs.h/2 - 5, 5, 0, Math.PI*2);
                    ctx.fill();
                }

                if (!obs.collected && 
                    player.x < obs.x + obs.w &&
                    player.x + player.width > obs.x &&
                    player.y < obs.y + obs.h &&
                    player.y + player.height > obs.y) {
                    
                    if (obs.type === 'heart') {
                        obs.collected = true;
                        score++;
                        document.getElementById('scoreDisplay').innerText = score;
                        playSound('collect');
                        createParticles(obs.x + obs.w/2, obs.y + obs.h/2, '#ff4757');
                    } else if (obs.type === 'rock') {
                        gameOver();
                    }
                }

                if (obs.x + obs.w < 0) obstacles.splice(i, 1);
            }

            for (let i = floaters.length - 1; i >= 0; i--) {
                let f = floaters[i];
                f.x -= gameSpeed;

                ctx.fillStyle = '#fff';
                ctx.beginPath();
                if(ctx.roundRect) {
                     ctx.roundRect(f.x, f.y, f.w, f.h, 10);
                } else {
                     ctx.rect(f.x, f.y, f.w, f.h);
                }
                ctx.fill();

                if (f.hasBoy) {
                    ctx.drawImage(boyImg, f.x + 30, f.y - 50, 60, 60);
                }

                if (f.x + f.w < 0) floaters.splice(i, 1);
            }

            for(let i=particles.length-1; i>=0; i--) {
                let p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.life -= 0.05;
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, 3, 0, Math.PI*2);
                ctx.fill();
                ctx.globalAlpha = 1;
                if(p.life <= 0) particles.splice(i, 1);
            }

            if (activeSpeech) {
                activeSpeech.x -= gameSpeed;
                activeSpeech.life--;
                
                ctx.save();
                ctx.font = 'bold 16px Nunito';
                let textWidth = ctx.measureText(activeSpeech.text).width;
                let bubbleW = textWidth + 30;
                let bubbleH = 40;
                let bx = activeSpeech.x + 40;
                let by = activeSpeech.y - 80;

                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.moveTo(bx, by + bubbleH);
                ctx.lineTo(bx + 10, by + bubbleH + 10);
                ctx.lineTo(bx + 20, by + bubbleH);
                ctx.fill();

                ctx.beginPath();
                if(ctx.roundRect) {
                     ctx.roundRect(bx - 10, by, bubbleW, bubbleH, 10);
                } else {
                     ctx.rect(bx - 10, by, bubbleW, bubbleH);
                }
                ctx.fill();
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                ctx.stroke();

                ctx.fillStyle = '#333';
                ctx.fillText(activeSpeech.text, bx + 5, by + 25);
                ctx.restore();

                if (activeSpeech.life <= 0) activeSpeech = null;
            }

            if (frames % 100 === 0) spawnObstacle();
            if (frames % 600 === 0) spawnFloater();

            gameSpeed += 0.001;
            requestAnimationFrame(loop);
        }

        function drawBackground() {
            ctx.fillStyle = '#fff';
            let x1 = (bgOffset * 0.5) % canvas.width + canvas.width; 
            drawCloud(x1, 100, 1.2);
            let x2 = ((bgOffset * 0.2 + 400) % canvas.width) + canvas.width;
            drawCloud(x2, 200, 0.8);
        }

        function drawCloud(x, y, scale) {
            ctx.save();
            ctx.translate(x, y);
            ctx.scale(scale, scale);
            ctx.beginPath();
            ctx.arc(0, 0, 30, 0, Math.PI*2);
            ctx.arc(40, 0, 40, 0, Math.PI*2);
            ctx.arc(80, 0, 30, 0, Math.PI*2);
            ctx.fill();
            ctx.restore();
        }

        function triggerBoySpeech(x, y) {
            const text = boyPhrases[Math.floor(Math.random() * boyPhrases.length)];
            activeSpeech = {
                text: text,
                x: x,
                y: y,
                life: 180 // Increased to 3 seconds visibility
            };
        }

        function gameOver() {
            gameActive = false;
            playSound('hit');
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('stutiRunnerHighScore', highScore);
            }
            document.getElementById('finalScore').innerText = score;
            document.getElementById('game-over-screen').classList.remove('hidden');
        }

        if (!CanvasRenderingContext2D.prototype.roundRect) {
            CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
                if (w < 2 * r) r = w / 2;
                if (h < 2 * r) r = h / 2;
                this.beginPath();
                this.moveTo(x + r, y);
                this.arcTo(x + w, y, x + w, y + h, r);
                this.arcTo(x + w, y + h, x, y + h, r);
                this.arcTo(x, y + h, x, y, r);
                this.arcTo(x, y, x + w, y, r);
                this.closePath();
                return this;
            }
        }
    </script>
</body>
</html>